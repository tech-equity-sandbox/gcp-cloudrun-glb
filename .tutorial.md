# Explore Cloud Run Features

*Important: Please be patient. Allow a few seconds for the lab to initialize. A splash screen will appear in the cloud shell terminal in a moment.*

This asset enables you to explore traffic management capabilities on Cloud Run fully managed platform. 

You can use this asset to learn how to configure access to a Cloud Run service via the Google Cloud Global Load Balancer. 

The Google Cloud Load Balancer scenarios demonstrate integration with Cloud Armor to restrict access to the service, as well as integration with Cloud CDN to cache static content at the edge of the network.

**Time to complete**: About 30 minutes

**Prerequisites**: You need Project Owner or Editor Role.

## Outline

This asset enables you to perform the following activities:

- Enable APIs
- Explore revision based traffic routing 
- Explore tag based traffic routing 
- Configure access via Global Load Balancer 
- Restrict access with Cloud Armor 
- Cache requests using Cloud CDN 

To explore Cloud Run, click **Start** .

## Step 0: Setup

### Select project

You will use this project to deploy the resources required for this lab.

*Hint: This should be an existing project where you are an Owner, or have permissions to enable APIs.*

<walkthrough-project-setup billing="true"></walkthrough-project-setup>

The project you selected is **{{project-id}}**. If this is blank, make sure you selected a project using the drop-down box above.

With a project selected, enter any key to continue and display the menu.

Enter `m` at the prompt to perform additional steps. 

To change to from preview mode to resource creation mode, enter `n` at the prompt. 

If prompted for a code, enter a valid code. For help, contact `support@techequity.cloud`.

### Sign in

You need to authenticate to `gcloud` to complete the lab.

When prompted to authenticate, enter `y`, click the link displayed, sign-in using your Google Cloud account, and click the `Allow` button to grant permissions to Google Cloud SDK. 

Click the `Copy` button to copy the authorization code. 

Return to the cloud shell terminal and paste the authorization code into the prompt to authenticate to cloud shell.

When prompted to change the project from `NOT_SET`, enter `y` and enter {{project-id}} as the new project ID. 

Enter any key at the `$` prompt to return to the menu. 

## Step 1: Enable APIs

You need to enable the APIs in the project to perform the required tasks. 

You only need to do this once for your operating project. 

Enter `1` at the additional steps to perform prompt to enable the API.  

Note the list of APIs enabled.

To deploy a sample service and explore revision based traffic routing, click **Next** 

## Step 2 Explore revision based traffic routing

### Deploy version 1.0 of the service

Enter `2` at the additional steps to explore revision based traffic routing.

Review the command to deploy version 1.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path and maximum number of instances. 

Click the Service URL on the terminal to access the service. 

Review the configuration of the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}})

### Configure IAM policy bindings 

Review the command to configure IAM policy bindings for the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the member and role. 

### Deploy version 2.0 of service

Review the command to deploy version 2.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path and maximum number of instances.

### Explore traffic routing

Enter any key at the prompt to continue and route 100% of the traffic to version 2.0 of the service. 

Note the command line options specifying the option directing 100% of the traffic to the latest version of the service, specifying the platform as managed, and the region.

Access the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}}) and explore traffic management capabilities using the UI under the REVISIONS tab.

Enter any key at the `$` prompt to return to the menu. Click **Next**

## Step 3: Explore tag based traffic routing

### Deploy version 1.0 of service

Enter `3` at the additional steps to explore tag based traffic routing.

Review the command to deploy version 1.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path, the tag and maximum number of instances. 

Click the Service URL on the terminal to access the service. 

Review the configuration of the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}})

### Deploy version 2.0 of service

Explore the command to deploy version 2.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path, the version tag and maximum number of instances.

### Explore traffic routing

Enter any key at the prompt to continue and route 10% of the traffic to version 2.0 of the service. 

Note the command line options specifying the option directing 10% of the traffic to the latest version of the service, the platform as managed, and the region.

Enter any key at the prompt to continue and route 90% of the traffic to version 2.0 of the service. 

Note the command line options specifying the option directing 90% of the traffic to the latest version of the service, the platform as managed, and the region.

Access the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}}) and explore traffic management capabilities using the UI under the REVISIONS tab.

Enter any key at the `$` prompt to return to the menu. Click **Next**

## Step 4: Configure access via the Global Load Balancer

### Deploy version 1.0 of service

Enter `4` at the additional steps to explore Google Cloud Global Load Balancer configuration.

Review the command to deploy version 1.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path, the tag and maximum number of instances. 

Click the Service URL on the terminal to access the service. 

Review the configuration of the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}})

### Create global static IP address

Explore the command to for creating a global static IP address.

Note the command line option --global 

### Create a serverless network endpoint group (NEG)

Note the command line options specifying the region, NEG type and Cloud Run service name.

### Create backend service

Note the command line options specifying the load balancer scheme and global nature of the service.

### Add the serverless network endpoint group to the backend service

Note the command line options specifying the network endpoint group region and global nature of the service.

### Create URL map

Note the command line option referring to the service.

### Create SSL certificate

Note the command line option referring to the domain.

### Create target HTTPS proxy

Note the command line option referring to the SSL certificate and URL map.

### Create forwarding rule

Note the command line option referring to the target HTTP proxy, the ports, and global IP address.

Certificate provisioning takes about 15 minutes. While waiting, explore the Global Load Balancer configuration  on the [Google Cloud Console](https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers?cloudshell=true&project={{project-id}}).

Enter any key at the `$` prompt to return to the menu. Click **Next**

## Step 5: Secure access via the Global Load Balancer with Cloud Armor

### Deploy version 1.0 of service

Enter `4` at the additional steps to explore Google Cloud Global Load Balancer configuration.

Review the command to deploy version 1.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path, the tag and maximum number of instances. 

Click the Service URL on the terminal to access the service. 

Review the configuration of the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}})

### Create global static IP address

Explore the command to for creating a global static IP address.

Note the command line option --global 

### Create a serverless network endpoint group (NEG)

Note the command line options specifying the region, NEG type and Cloud Run service name.

### Create backend service

Note the command line options specifying the load balancer scheme and global nature of the service.

### Add the serverless network endpoint group to the backend service

Note the command line options specifying the network endpoint group region and global nature of the service.

### Create URL map

Note the command line option referring to the service.

### Create SSL certificate

Note the command line option referring to the domain.

### Create target HTTPS proxy

Note the command line option referring to the SSL certificate and URL map.

### Create forwarding rule

Note the command line option referring to the target HTTPS proxy, the ports, and global IP address.

*Important: Certificate provisioning takes about 15 minutes. You must wait until the certificates have been provisioned before carrying on to the next stage.*

### Create security policy

Note the policy description on the command line.

### Update default rules

Note the action and rule priority.

### Restrict access to a desired IP

Note the rule priority, action and source IP address ranges.

### Attach policy to backend service

Note the reference to the global security policy.

Explore the Global Load Balancer configuration  on the [Google Cloud Console](https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers?cloudshell=true&project={{project-id}}).

Enter any key at the `$` prompt to return to the menu. Click **Next**

## Step 6: Cache static content served via the Global Load Balancer with Cloud CDN

### Deploy version 1.0 of service

Enter `4` at the additional steps to explore Google Cloud Global Load Balancer configuration.

Review the command to deploy version 1.0 of the helloworld service. 

Note the command line options specifying the platform as managed, the region where the service is deployed, the command line option to allowing access by unauthenticated users, the image URL path, the tag and maximum number of instances. 

Click the Service URL on the terminal to access the service. 

Review the configuration of the service on the [Google Cloud Console](https://console.cloud.google.com/run?project={{project-id}})

### Create global static IP address

Explore the command to for creating a global static IP address.

Note the command line option --global 

### Create a serverless network endpoint group (NEG)

Note the command line options specifying the region, NEG type and Cloud Run service name.

### Create backend service

Note the command line options specifying the load balancer scheme, global nature of the service, enabling CDN, configuring the cache mode and custom response header.

### Add the serverless network endpoint group to the backend service

Note the command line options specifying the network endpoint group region and global nature of the service.

### Create URL map

Note the command line option referring to the service.

### Create SSL certificate

Note the command line option referring to the domain.

### Create target HTTPS proxy

Note the command line option referring to the SSL certificate and URL map.

### Create forwarding rule

Note the command line option referring to the target HTTPS proxy, the ports, and global IP address.

Certificate provisioning takes about 15 minutes. While waiting, explore the Global Load Balancer configuration  on the [Google Cloud Console](https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers?cloudshell=true&project={{project-id}}).

Enter any key at the `$` prompt to return to the menu. Click **Next**

## Step 7: Delete resources

Enter `m` at the prompt to perform additional steps. 

To change from create mode to delete mode, enter `d` at the prompt and enter any key to return to the main menu.

Select the step you would like to delete and follow the prompts to confirm deletion.